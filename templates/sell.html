{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0"><i class="fas fa-arrow-down text-danger"></i> Sell Stocks</h4>
            </div>
            <div class="card-body">
                <form method="POST">
                    {{ form.hidden_tag() }}
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.symbol.label(class="form-label") }}
                                <div class="input-group">
                                    {{ form.symbol(class="form-control", placeholder="e.g., AAPL, GOOGL, MSFT", oninput="checkStock()") }}
                                    <button class="btn btn-outline-secondary" type="button" onclick="checkStock()">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                                {% for error in form.symbol.errors %}
                                    <div class="text-danger">{{ error }}</div>
                                {% endfor %}
                                <div id="stock-info" class="mt-2"></div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.shares.label(class="form-label") }}
                                {{ form.shares(class="form-control", placeholder="Number of shares", oninput="calculateTotal()") }}
                                {% for error in form.shares.errors %}
                                    <div class="text-danger">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <div id="order-preview" class="alert alert-warning d-none">
                        <h6><i class="fas fa-calculator"></i> Sale Preview</h6>
                        <p id="preview-text"></p>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Cancel</a>
                        {{ form.submit(class="btn btn-danger") }}
                    </div>
                </form>
            </div>
        </div>
        
        {% if current_user.holdings %}
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-briefcase"></i> Your Holdings</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Shares Owned</th>
                                <th>Average Price</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for holding in current_user.holdings %}
                            <tr>
                                <td><strong>{{ holding.symbol }}</strong></td>
                                <td>{{ holding.shares }}</td>
                                <td>${{ "%.2f"|format(holding.avg_price) }}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-danger" onclick="fillSellStock('{{ holding.symbol }}', {{ holding.shares }})">
                                        Select to Sell
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% else %}
        <div class="card mt-4">
            <div class="card-body text-center">
                <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                <h5>No stocks in your portfolio</h5>
                <p class="text-muted">You need to buy stocks before you can sell them!</p>
                <a href="{{ url_for('buy') }}" class="btn btn-success">
                    <i class="fas fa-plus"></i> Buy Stocks
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
let currentPrice = 0;

function fillSellStock(symbol, maxShares) {
    document.getElementById('symbol').value = symbol;
    document.getElementById('shares').setAttribute('max', maxShares);
    checkStock();
}

function checkStock() {
    const symbol = document.getElementById('symbol').value.toUpperCase();
    const stockInfo = document.getElementById('stock-info');
    
    if (!symbol) {
        stockInfo.innerHTML = '';
        return;
    }
    
    stockInfo.innerHTML = '<div class="text-muted"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
    
    fetch(`/api/stock/${symbol}`)
        .then(response => response.json())
        .then(data => {
            if (data.valid) {
                currentPrice = data.price;
                
                // Check if user owns this stock
                const ownedShares = getOwnedShares(symbol);
                const infoClass = ownedShares > 0 ? 'alert-success' : 'alert-warning';
                const ownedText = ownedShares > 0 ? 
                    `You own ${ownedShares} shares` : 
                    'You don\'t own this stock';
                
                stockInfo.innerHTML = `
                    <div class="alert ${infoClass}">
                        <i class="fas fa-check-circle"></i> 
                        <strong>${data.symbol}</strong> - Current Price: <strong>$${data.price.toFixed(2)}</strong><br>
                        <small>${ownedText}</small>
                    </div>
                `;
                calculateTotal();
            } else {
                currentPrice = 0;
                stockInfo.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle"></i> Invalid stock symbol
                    </div>
                `;
            }
        })
        .catch(error => {
            currentPrice = 0;
            stockInfo.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> Error fetching stock data
                </div>
            `;
        });
}

function getOwnedShares(symbol) {
    const holdings = {{ current_user.holdings | tojson }};
    const holding = holdings.find(h => h.symbol === symbol);
    return holding ? holding.shares : 0;
}

function calculateTotal() {
    const symbol = document.getElementById('symbol').value.toUpperCase();
    const shares = parseInt(document.getElementById('shares').value) || 0;
    const preview = document.getElementById('order-preview');
    const previewText = document.getElementById('preview-text');
    
    if (shares > 0 && currentPrice > 0 && symbol) {
        const total = shares * currentPrice;
        const ownedShares = getOwnedShares(symbol);
        
        previewText.innerHTML = `
            <strong>Sale Details:</strong><br>
            ${shares} shares × $${currentPrice.toFixed(2)} = <strong>$${total.toFixed(2)}</strong><br>
            ${shares > ownedShares ? 
                '<span class="text-danger">⚠️ You don\'t own enough shares!</span>' : 
                '<span class="text-success">✓ Sale can be completed</span>'
            }
        `;
        preview.classList.remove('d-none');
    } else {
        preview.classList.add('d-none');
    }
}
</script>
{% endblock %}